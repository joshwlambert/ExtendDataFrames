<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ExtendDataFrames">
<title>Custom-class-and-dplyr-compatibility • ExtendDataFrames</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Custom-class-and-dplyr-compatibility">
<meta property="og:description" content="ExtendDataFrames">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ExtendDataFrames</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/ExtendDataFrames.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Custom-class-and-dplyr-compatibility.html">Custom-class-and-dplyr-compatibility</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Custom-class-and-dplyr-compatibility</h1>
            
      
      
      <div class="d-none name"><code>Custom-class-and-dplyr-compatibility.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://joshwlambert.github.io/ExtendDataFrames/">ExtendDataFrames</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span></code></pre></div>
<div class="section level2">
<h2 id="extending-data-frames-in-r">Extending Data Frames in R<a class="anchor" aria-label="anchor" href="#extending-data-frames-in-r"></a>
</h2>
<p>R is a commonly used language for data science and statistical
computing. Foundational to this is having data structures that allow
manipulation of data with minimal effort and cognitive load. One of the
most commonly required data structures is tabular data. This can be
represented in R in a few ways, for example a matrix or a data frame.
The data frame (class <code>data.frame</code>) is a flexible tabular
data structure, as it can hold different data types (e.g. numbers,
character strings, etc.) across different columns. This is in contrast
to matrices – which are arrays with dimensions – and thus can only hold
a single data type.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># data frame can hold heterogeneous data types across different columns</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">6</span><span class="op">)</span>, c <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   a b c</span></span>
<span><span class="co">#&gt; 1 1 4 a</span></span>
<span><span class="co">#&gt; 2 2 5 b</span></span>
<span><span class="co">#&gt; 3 3 6 c</span></span>
<span></span>
<span><span class="co"># each column must be of the same type</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"4"</span>, <span class="fl">5</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># be careful of the silent type conversion</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">a</span></span>
<span><span class="co">#&gt; [1] 1 2 3</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">b</span></span>
<span><span class="co">#&gt; [1] "4" "5" "6"</span></span>
<span></span>
<span><span class="va">mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">9</span>, nrow <span class="op">=</span> <span class="fl">3</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">mat</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3]</span></span>
<span><span class="co">#&gt; [1,]    1    4    7</span></span>
<span><span class="co">#&gt; [2,]    2    5    8</span></span>
<span><span class="co">#&gt; [3,]    3    6    9</span></span>
<span><span class="va">mat</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"1"</span></span>
<span><span class="co"># be careful of the silent type conversion</span></span>
<span><span class="va">mat</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3]</span></span>
<span><span class="co">#&gt; [1,] "1"  "4"  "7" </span></span>
<span><span class="co">#&gt; [2,] "2"  "5"  "8" </span></span>
<span><span class="co">#&gt; [3,] "3"  "6"  "9"</span></span></code></pre></div>
<p>Data frames can even be nested, cells can be data frames or
lists.</p>
<p>[INSERT CODE EXAMPLE OF NESTED DF HERE]</p>
<p>It is therefore clear why data frames are so prevalent. However, they
are not without limitations. They have a relatively basic printing
method which can fload the R console when the number of columns or rows
is large. They have useful methods (e.g., <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> and
<code><a href="https://rdrr.io/r/utils/str.html" class="external-link">str()</a></code>), but these might not be appropriate for certain
types of tabular data. In these cases it is useful to utilise R’s
inheritance mechanisms (specifically S3 inheritance) to write extensions
for R’s <code>data.frame</code> class. In this case the data frame is
the superclass and the new subclass extends it and inherits its methods
(see Adv R<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;&lt;a href="https://adv-r.hadley.nz/s3.html?q=inherita#s3-inheritance" class="external-link uri"&gt;https://adv-r.hadley.nz/s3.html?q=inherita#s3-inheritance&lt;/a&gt;&lt;/p&gt;'><sup>1</sup></a> for more details on S3 inheritance).</p>
<p>One of the most common extension of the data frame is the
<code>tibble</code> from the {tibble} R package. Outlined in {tibble}‘s
’Tibbles’ vignette<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;&lt;a href="https://tibble.tidyverse.org/articles/tibble.html" class="external-link uri"&gt;https://tibble.tidyverse.org/articles/tibble.html&lt;/a&gt;&lt;/p&gt;'><sup>2</sup></a>, <code>tibble</code>s offer improvements in
printing, subsetting and recycling rules. Another commonly used data
frame extension is the <code>data.table</code> class from the
{data.table} R package <a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;&lt;a href="https://github.com/Rdatatable/data.table" class="external-link uri"&gt;https://github.com/Rdatatable/data.table&lt;/a&gt;&lt;/p&gt;'><sup>3</sup></a>. This class is primarily designed to
improve the performance (i.e. speed and efficiency of operations and
storage) of working with tabular data in R.</p>
<p>In the process of developing R software (most likely an R package), a
new tabular data class that builds atop data frames can become
beneficial. This blog post has two main sections: 1) a brief overview of
the steps required to setup a class that extends data frames 2) guide to
the technical aspects of class invariants and design and implementation
decisions, and tidyverse compatibility</p>
<div class="section level3">
<h3 id="writing-custom-data-class">Writing custom data class<a class="anchor" aria-label="anchor" href="#writing-custom-data-class"></a>
</h3>
<p>It is useful to write a class constructor function that can be called
to create an object of your new class. The functions define below are a
redacted version (for readability) of functions also defined in the
package.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">birthdays</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># the vector of classes is required for it to inherit from `data.frame`</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="va">x</span>, class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"birthdays"</span>, <span class="st">"data.frame"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>That’s all that’s needed to create a subclass of a data frame.
However, although we’ve created the class we haven’t given it any
functionality and thus it will be identical to a data frame due to
inheritance.</p>
<p>We can now write as many methods as we want. Here we will show two
methods, one of which does not require writing a generic and the second
that does.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">print.birthdays</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>      <span class="st">"A `birthdays` object with %s rows and %s cols"</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">birthdays_per_month</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">UseMethod</a></span><span class="op">(</span><span class="st">"birthdays_per_month"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">birthdays_per_month.birthdays</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html" class="external-link">month</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">birthday</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">months</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"Jan"</span>, <span class="st">"Feb"</span>, <span class="st">"Mar"</span>, <span class="st">"Apr"</span>, <span class="st">"May"</span>, <span class="st">"Jun"</span>,</span>
<span>    <span class="st">"Jul"</span>, <span class="st">"Aug"</span>, <span class="st">"Sep"</span>, <span class="st">"Oct"</span>, <span class="st">"Nov"</span>, <span class="st">"Dec"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">months</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Useful resources for the “Writing custom data class” section:</p>
<ul>
<li><a href="https://tibble.tidyverse.org/articles/extending.html" class="external-link">extending
<code>tibbles</code> and their functionality</a></li>
</ul>
</div>
<div class="section level3">
<h3 id="design-decision-around-class-invariants">Design decision around class invariants<a class="anchor" aria-label="anchor" href="#design-decision-around-class-invariants"></a>
</h3>
<p>Moving onto the second section of the post, in which we discuss the
design choices when creating and using S3 classes in R.
<strong><em>Class invariants</em></strong> are members of your class
that define it. In other words, without these elements your class does
not fulfil its basic definition. It is therefore sensible to make sure
that your class contains these elements at all times (or at least after
operations have been applied to your class). In cases when the class
object contains all the invariants normal service can be continued.
However, in the case that an invariant is missing or modified to a
non-conformist type (e.g. a date converted to a numer) a decision has to
be made. Either the code can error, hopefully giving the user an
informative message as to why their modification broke the object;
alternatively, the subclass can be revoke and the superclass can be
returned. In almost all cases the superclass (i.e. the base class being
inherited from) is more general and won’t have the same class invariant
restrictions.</p>
<p>For our example class, <code>birthdays</code>, the invariants are a
column called <code>name</code> which must contain characters, and a
column called <code>birthday</code> which must contain dates. The order
of the rows and columns is not considered an invariant property, and
having extra columns with other names and data types is also allowed.
The number of rows is also not an invariant as we can have as many
birthdays as we like in the data object.</p>
<p>Here we present both cases and considerations and technical details
of both options. We’ll demonstrate both of these cases with the subset
function in R (subsetting uses a single square bracket for tabular data,
<code>[</code>). First the fail-on-subsetting. Before we write the
subsetting function it is useful to have a function that checks that an
object of our class is valid, a so-called validator function.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">validate_birthdays</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span></span>
<span>    <span class="st">"input must contain 'name' and 'birthday' columns"</span> <span class="op">=</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"name"</span>, <span class="st">"birthday"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="st">"names must be a character"</span> <span class="op">=</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">is.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">name</span><span class="op">)</span>,</span>
<span>    <span class="st">"birthday must be a date"</span> <span class="op">=</span></span>
<span>      <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/date_utils.html" class="external-link">is.Date</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">birthday</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This will return an error if the class is not valid (defined in terms
of the class’ invariants).</p>
<p>Now we can show how to error if one of the invariants are removed
during subsetting.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">[.birthdays</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">validate_birthdays</span>(<span class="fu">NextMethod</span>())</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>birthdays[, <span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    Error <span class="cf">in</span> <span class="fu">validate_birthdays</span>(<span class="fu">NextMethod</span>()) <span class="sc">:</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    input must contain <span class="st">'name'</span> and <span class="st">'birthday'</span> columns</span></code></pre></div>
<p>The second design option is the check whether the class is valid, and
if not downgrade the class to the superclass, in our case a data frame.
This is done by not only validating the object during subsetting but to
check whether it is a valid class object, and then either ensuring all
of the attributes of the subclass – in our case <code>birthdays</code> –
are maintained, or attributes are stripped and only the attributes of
the base superclass – in our case <code>data.frame</code> – are
kept.</p>
<p><strong><em>Important note: this section of the post relies heavily
on</em></strong> <a href="https://github.com/DavisVaughan/2020-06-01_dplyr-vctrs-compat" class="external-link uri">https://github.com/DavisVaughan/2020-06-01_dplyr-vctrs-compat</a>.</p>
<p>The four functions that are required to be added to ensure our class
is correctly handled when invaliding it are:</p>
<ul>
<li><code><a href="../reference/birthdays_reconstruct.html">birthdays_reconstruct()</a></code></li>
<li><code><a href="../reference/birthdays_can_reconstruct.html">birthdays_can_reconstruct()</a></code></li>
<li><code><a href="../reference/df_reconstruct.html">df_reconstruct()</a></code></li>
<li><code>dplyr_reconstruct.birthdays()</code></li>
</ul>
<p>We’ll tackle the first three first, and then move onto to the last
one as this requires some extra steps.</p>
<p><code><a href="../reference/birthdays_reconstruct.html">birthdays_reconstruct()</a></code> is a function that contains an
if-else statement to determine whether the returned object is a
<code>birthdays</code> or <code>data.frame</code> object.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">birthdays_reconstruct</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">to</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/birthdays_can_reconstruct.html">birthdays_can_reconstruct</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/df_reconstruct.html">df_reconstruct</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">to</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"data.frame"</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Removing crucial column in `&lt;birthdays&gt;` returning `&lt;data.frame&gt;`"</span><span class="op">)</span></span>
<span>    <span class="va">x</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The if-else evaluation is controlled by
<code><a href="../reference/birthdays_can_reconstruct.html">birthdays_can_reconstruct()</a></code>. This function determines
whether after subsetting the object is a valid
<code>&lt;birthdays&gt;</code> class. It does this by running the class
validator, and if validation fails, by throwing an error, it returns
<code>FALSE</code>, otherwise the function will return
<code>TRUE</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">birthdays_can_reconstruct</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># check whether input is valid</span></span>
<span>  <span class="va">valid</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>    <span class="op">{</span> <span class="fu"><a href="../reference/validate_birthdays.html">validate_birthdays</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">}</span>,</span>
<span>    error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">cnd</span><span class="op">)</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># return boolean</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isFALSE</a></span><span class="op">(</span><span class="va">valid</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The next function required is <code><a href="../reference/df_reconstruct.html">df_reconstruct()</a></code>. This is
called when the object is judged to be a valid
<code>&lt;birthdays&gt;</code> object and simply copies the attributes
over from the <code>&lt;birthdays&gt;</code> class to the object being
subset.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_reconstruct</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">to</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">attrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attributes.html" class="external-link">attributes</a></span><span class="op">(</span><span class="va">to</span><span class="op">)</span></span>
<span>  <span class="va">attrs</span><span class="op">$</span><span class="va">names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">attrs</span><span class="op">$</span><span class="va">row.names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/base-internal.html" class="external-link">.row_names_info</a></span><span class="op">(</span><span class="va">x</span>, type <span class="op">=</span> <span class="fl">0L</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attributes.html" class="external-link">attributes</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">attrs</span></span>
<span>  <span class="va">x</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The three functions defined for reconstruction can be added to a
package with the subsetting function in order to subset
<code>&lt;birthdays&gt;</code> objects and returning either
<code>&lt;birthdays&gt;</code> objects if still valid, or data frames
when invalidated. This design has the benefit that when conducting data
exploration a user is not faced with an error, but can continue with a
data frame, while being informed by the message printed to console in
<code><a href="../reference/birthdays_reconstruct.html">birthdays_reconstruct()</a></code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`[.birthdays`</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">NextMethod</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/birthdays_reconstruct.html">birthdays_reconstruct</a></span><span class="op">(</span><span class="va">out</span>, <span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="compatibility-with-dplyr">Compatibility with {dplyr}<a class="anchor" aria-label="anchor" href="#compatibility-with-dplyr"></a>
</h3>
<p>In order to be able to operate on our <code>&lt;birthdays&gt;</code>
class using functions from the package {dplyr}, as would be common for
data frames, we need to make our function compatible. This is where the
function <code>dplyr_reconstruct.birthdays()</code> comes in.
<code><a href="https://dplyr.tidyverse.org/reference/dplyr_extending.html" class="external-link">dplyr_reconstruct()</a></code> is a generic function exported by
{dplyr}. It is called in {dplyr} verbs to make sure that the objects are
restored to the input class when not invalidated.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Registered in `.onLoad()` in zzz.R</span></span>
<span><span class="va">dplyr_reconstruct.birthdays</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">template</span><span class="op">)</span> <span class="op">{</span> <span class="co"># nolint</span></span>
<span>  <span class="fu"><a href="../reference/birthdays_reconstruct.html">birthdays_reconstruct</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">template</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Information about the generic can be found through the {dplyr} help
documentation.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">?</span><span class="va">dplyr_extending</span></span>
<span><span class="op">?</span><span class="fu">dplyr</span><span class="fu">::</span><span class="va"><a href="https://dplyr.tidyverse.org/reference/dplyr_extending.html" class="external-link">dplyr_reconstruct</a></span></span></code></pre></div>
<p>As explained in the help documentation {dplyr} also uses two other
base R functions to perform data manipulation. <code>names&lt;-</code>
(i.e the names setter function) and <code>[</code> the one-dimensional
subsetting function. We therefore define these methods for our custom
class in order for <code><a href="https://dplyr.tidyverse.org/reference/dplyr_extending.html" class="external-link">dplyr_reconstruct()</a></code> to work as
intended.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`[.birthdays`</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">NextMethod</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/birthdays_reconstruct.html">birthdays_reconstruct</a></span><span class="op">(</span><span class="va">out</span>, <span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">`names&lt;-.birthdays`</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">value</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">NextMethod</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/birthdays_reconstruct.html">birthdays_reconstruct</a></span><span class="op">(</span><span class="va">out</span>, <span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This wraps up the need for adding function to perform data
manipulation using the reconstruction design outlined above. However,
there is some final housekeeping to do. You may have noticed the
<code># Registered in</code>.onLoad()<code>in zzz.R</code> comment when
defining <code>dplyr_reconstruct.birthdays()</code> above. This is
because in order to not depend on the entire {dplyr} package but
requiring the <code><a href="https://dplyr.tidyverse.org/reference/dplyr_extending.html" class="external-link">dplyr_reconstruct()</a></code> generic we need to
register this when the package is loaded using the
<code>.onLoad()</code> function.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">libname</span>, <span class="va">pkgname</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">s3_register</span><span class="op">(</span><span class="st">"dplyr::dplyr_reconstruct"</span>, <span class="st">"birthdays"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The <code>s3_register()</code> function used in
<code>.onLoad()</code> also needed to be added to the package and this
function is kindly supplied by both {vctrs} and {rlang} unlicensed and
thus can be copied into another package.</p>
<p>Compatibility with {vctrs} is also possible using the same mechanism
(functions) described in this post, and if insterested see <a href="https://github.com/DavisVaughan/2020-06-01_dplyr-vctrs-compat" class="external-link uri">https://github.com/DavisVaughan/2020-06-01_dplyr-vctrs-compat</a>
for details.</p>
<p>This blog post is a compendium of information from sources that are
linked and cited throughout. Please refer to those sites for more
information and as the primary source for citation in further work.</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Joshua W. Lambert.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
